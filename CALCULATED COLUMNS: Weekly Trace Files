INDEX = RANKX(ALL('Weekly Trace Files'), [ICN/KO] & VALUE(FORMAT('Weekly Trace Files'[DATA_DATE], "YYYYMMDD")) & [SY], , ASC, Dense)

WEEK START = IF(OR(WEEKDAY([DATA_DATE], 3) = 5, WEEKDAY([DATA_DATE], 3) = 6), [DATA_DATE] - WEEKDAY([DATA_DATE], 3), [DATA_DATE] - WEEKDAY([DATA_DATE], 3) - 7)

WEEK END = [WEEK START] + 6

MAX ACTUAL START DATE = CALCULATE(MAX([ACTUAL START DATE]), ALLEXCEPT('Weekly Trace Files', 'Weekly Trace Files'[ICN/KO]))

MAX ACTUAL COMPLETE DATE = CALCULATE(MAX([ACTUAL COMPLETE DATE]), ALLEXCEPT('Weekly Trace Files', 'Weekly Trace Files'[ICN/KO]))

PREVIOUS CURRENT START DATE = LOOKUPVALUE('Weekly Trace Files'[CURRENT START DATE], 'Weekly Trace Files'[ICN/KO], [ICN/KO], 'Weekly Trace Files'[INDEX], [INDEX] - 1)

PREVIOUS CURRENT COMPLETION DATE = LOOKUPVALUE('Weekly Trace Files'[CURRENT COMPLETION DATE], 'Weekly Trace Files'[ICN/KO], [ICN/KO], 'Weekly Trace Files'[INDEX], [INDEX] - 1)

SCHEDULED START DATE = IF([MAX ACTUAL START DATE] >= [WEEK START] && [MAX ACTUAL START DATE] <= [WEEK END] && [PREVIOUS CURRENT START DATE] > [WEEK END] && [PREVIOUS CURRENT START DATE] < [WEEK END] + 42, [PREVIOUS CURRENT START DATE], BLANK())

SCHEDULED COMPLETE DATE = IF([MAX ACTUAL COMPLETE DATE] >= [WEEK START] && [MAX ACTUAL COMPLETE DATE] <= [WEEK END] && [PREVIOUS CURRENT COMPLETION DATE] > [WEEK END] && [PREVIOUS CURRENT COMPLETION DATE] < [WEEK END] + 42, [PREVIOUS CURRENT COMPLETION DATE], BLANK())

MAX SCHEDULED START DATE = CALCULATE(MAX([SCHEDULED START DATE]), ALLEXCEPT('Weekly Trace Files', 'Weekly Trace Files'[ICN/KO]))

MAX SCHEDULED COMPLETE DATE = CALCULATE(MAX([SCHEDULED COMPLETE DATE]), ALLEXCEPT('Weekly Trace Files', 'Weekly Trace Files'[ICN/KO]))

SCHEDULED TO START = IF([MAX SCHEDULED START DATE] >= [WEEK START] && [MAX SCHEDULED START DATE] <= [WEEK END], "YES", IF(OR([MAX ACTUAL START DATE] = BLANK(), [MAX ACTUAL START DATE] >= [WEEK START]) && [MAX SCHEDULED START DATE] = BLANK() && [PREVIOUS CURRENT START DATE] >= [WEEK START] && [PREVIOUS CURRENT START DATE] <= [WEEK END] && OR([PREVIOUS ERD] = BLANK(), [PREVIOUS ERD] <= [WEEK END]), "YES", BLANK()))

ON-TIME START = IF([SCHEDULED TO START] = "YES" && [MAX ACTUAL START DATE] <> BLANK() && [MAX ACTUAL START DATE] <= [WEEK END], "YES", BLANK())

SCHEDULED TO COMPLETE = IF([MAX SCHEDULED COMPLETE DATE] >= [WEEK START] && [MAX SCHEDULED COMPLETE DATE] <= [WEEK END], "YES", IF(OR([MAX ACTUAL COMPLETE DATE] = BLANK(), [MAX ACTUAL COMPLETE DATE] >= [WEEK START]) && [MAX SCHEDULED COMPLETE DATE] = BLANK() && [PREVIOUS CURRENT COMPLETION DATE] >= [WEEK START] && [PREVIOUS CURRENT COMPLETION DATE] <= [WEEK END]  && OR([PREVIOUS ERD] = BLANK(), [PREVIOUS ERD] <= [WEEK END]), "YES", BLANK()))

ACTUAL COMPLETE = IF([MAX ACTUAL COMPLETE DATE] >= [WEEK START] && [MAX ACTUAL COMPLETE DATE] <= [WEEK END], "YES", BLANK())

ON-TIME COMPLETE = IF([SCHEDULED TO COMPLETE] = "YES" && [MAX ACTUAL COMPLETE DATE] <> BLANK() && [MAX ACTUAL COMPLETE DATE] <= [WEEK END], "YES", BLANK())

FUTURE COMPLETION DATE WEEK START = IF([IS MAX WEEK START] = "YES" && [CURRENT COMPLETION DATE] > [WEEK END] && [ACTUAL COMPLETE DATE] = BLANK(), [CURRENT COMPLETION DATE] - WEEKDAY([CURRENT COMPLETION DATE], 3), BLANK())

TIED TO UNDOCKING = IF(LOOKUPVALUE('Key Events for Undocking'[Key Events for Undocking], 'Key Events for Undocking'[Key Events for Undocking], [KEY EVENT TRACE]) <> BLANK(), "YES", BLANK())

TIED T0 COMPLETE AVAIL = IF([KEY EVENT TRACE] <> "EG00", "YES", BLANK())

CERT DATE WEEK START = IF([CUM CRT]<>BLANK(), [CUM CRT] - WEEKDAY([CUM CRT], 3), BLANK())

CUM CRT = IF([IS MAX WEEK START] = "YES", [CERT DATE], BLANK())

PHASE = MID([ICN/KO], 11, 1)

ACTUAL START = IF([MAX ACTUAL START DATE] >= [WEEK START] && [MAX ACTUAL START DATE] <= [WEEK END], "YES", BLANK())

EARLY FINISH DATE = IF([IS MAX WEEK START] = "YES", LOOKUPVALUE('Latest Weekly Throughput EV'[Rev EF], 'Latest Weekly Throughput EV'[ICN/KO], [ICN/KO]), BLANK())

LATE FINISH DATE = IF([IS MAX WEEK START] = "YES", LOOKUPVALUE('Latest Weekly Throughput EV'[Rev LF], 'Latest Weekly Throughput EV'[ICN/KO], [ICN/KO]), BLANK())

EARLY FINISH WEEK START = [EARLY FINISH DATE] - WEEKDAY([EARLY FINISH DATE], 3)

LATE FINISH WEEK START = [LATE FINISH DATE] - WEEKDAY([LATE FINISH DATE], 3)

IS MAX WEEK START = IF([WEEK START] = CALCULATE(MAX([WEEK START]), ALLEXCEPT('Weekly Trace Files', 'Weekly Trace Files'[SY])), "YES", BLANK())

THIS WEEK SCHEDULED TO START = IF([IS MAX WEEK START] = "YES", IF([CURRENT START DATE] >= [WEEK START] + 7 && [CURRENT START DATE] <= [WEEK END] + 7, "YES", BLANK()))

THIS WEEK SCHEDULED TO FINISH = IF([IS MAX WEEK START] = "YES", IF([CURRENT COMPLETION DATE] >= [WEEK START] + 7 && [CURRENT COMPLETION DATE] <= [WEEK END] + 7, "YES", BLANK()))

NEXT WEEK SCHEDULED TO START = IF([IS MAX WEEK START] = "YES", IF([CURRENT START DATE] >= [WEEK START] + 14 && [CURRENT START DATE] <= [WEEK END] + 14, "YES", BLANK()))

NEXT WEEK SCHEDULED TO FINISH = IF([IS MAX WEEK START] = "YES", IF([CURRENT COMPLETION DATE] >= [WEEK START] + 14 && [CURRENT COMPLETION DATE] <= [WEEK END] + 14, "YES", BLANK()))

BASELINE DATE = IF([IS MAX WEEK START] = "YES", DATEADD('Weekly Trace Files'[EARLY FINISH DATE], DATEDIFF([EARLY FINISH DATE], [LATE FINISH DATE], DAY) * 0.4, DAY), BLANK())

BASELINE DATE WEEK START = [BASELINE DATE] - WEEKDAY([BASELINE DATE], 3)

TOTAL CRT = IF([IS MAX WEEK START] = "YES" && [CERT DATE] <> BLANK() && [CERT DATE] <= [WEEK END], "YES", BLANK())

DROP IN = IF(OR([ICN/KO] <> LOOKUPVALUE('Weekly Trace Files'[ICN/KO], 'Weekly Trace Files'[ICN/KO], [ICN/KO], 'Weekly Trace Files'[INDEX], [INDEX] - 2), [SHOP CODE] <> LOOKUPVALUE('Weekly Trace Files'[SHOP CODE], 'Weekly Trace Files'[ICN/KO], [ICN/KO], 'Weekly Trace Files'[INDEX], [INDEX] - 2)), "YES", BLANK())

CURRENT WEEK WEEK START = [WEEK START] + 7

CURRENT WEEK WEEK END = [CURRENT WEEK WEEK START] + 6

NEXT WEEK WEEK START = [WEEK START] + 14

NEXT WEEK WEEK END = [NEXT WEEK WEEK START] + 6

Total Jobs = IF([IS MAX WEEK START] = "YES", 1, BLANK())

ACTUAL CERT = IF([CERT DATE] >= [WEEK START] && [CERT DATE] <= [WEEK END], "YES", BLANK())

IS FIRST DATA OF WEEK = IF([DATA_DATE] = CALCULATE(MIN([DATA_DATE]), ALLEXCEPT('Weekly Trace Files', 'Weekly Trace Files'[SY], 'Weekly Trace Files'[WEEK START])), "YES", BLANK())

SY-PROJ ID = [SY] & "-" & [PROJ ID]

IS MAX DATA DATE = IF([DATA_DATE] = CALCULATE(MAX([DATA_DATE]), ALLEXCEPT('Weekly Trace Files', 'Weekly Trace Files'[SY])), "YES", BLANK())

EARLY START = IF([SCHEDULED START DATE] <> BLANK(), DATEDIFF([ACTUAL START DATE], [SCHEDULED START DATE], WEEK)  & " WEEKS EARLY", BLANK())

EARLY COMPLETE = IF([SCHEDULED COMPLETE DATE] <> BLANK(), DATEDIFF([ACTUAL COMPLETE DATE], [SCHEDULED COMPLETE DATE], WEEK)  & " WEEKS EARLY", BLANK())

SCHEDULED THROUGHPUT = IF([PREVIOUS CURRENT COMPLETION DATE] >= [WEEK START] && [PREVIOUS CURRENT COMPLETION DATE] <= [WEEK END], "YES", BLANK())

PREVIOUS RDU_QY = LOOKUPVALUE('Weekly Trace Files'[RDU_QY], [WEEK START], [WEEK START] - 7, [ICN/KO], [ICN/KO])

Delta RDU_QY = IF([RDU_QY] <> BLANK() && [PREVIOUS RDU_QY] <> BLANK(), [PREVIOUS RDU_QY] - [RDU_QY], BLANK())

ADDED RDU = IF([Delta RDU_QY] < 0, "YES", BLANK())

RDU WEEK START = IF([ACTUAL START DATE] <> BLANK() && [ACTUAL START DATE] <= [WEEK START], [WEEK START], IF([ACTUAL START DATE] > [WEEK START] && [ACTUAL START DATE] <= [WEEK END], [ACTUAL START DATE], BLANK()))

RDU WEEK END = IF(OR([ACTUAL COMPLETE DATE] = BLANK(), [ACTUAL COMPLETE DATE] >= [WEEK END]), [WEEK END], IF([ACTUAL COMPLETE DATE] >= [WEEK START] && [ACTUAL COMPLETE DATE] < [WEEK END], [ACTUAL COMPLETE DATE], BLANK()))

SHIFTS IN WEEK = IF([RDU WEEK START] <> BLANK() && [RDU WEEK END] <> BLANK(), (DATEDIFF([RDU WEEK START], [RDU WEEK END], DAY) + 1) * VALUE(MID([CALENDAR CODE], 1, 1)), BLANK())

Delta EV = (([Total EV] * [% PROGRESS]) - (LOOKUPVALUE('Weekly Trace Files'[Total EV], [INDEX], [INDEX] - 1, 'Weekly Trace Files'[ICN/KO], [ICN/KO]) * LOOKUPVALUE('Weekly Trace Files'[% PROGRESS], [INDEX], [INDEX] - 1, 'Weekly Trace Files'[ICN/KO], [ICN/KO])))/100

Total EV = ([TASK WORK TYPE 'M'] + [TASK WORK TYPE 'N'] + [TASK WORK TYPE 'O'] + [TASK WORK TYPE 'R'])/8

Expected EV = IF([DURATION] > 0, [EV per Shift] * [SHIFTS IN WEEK], BLANK())

RDU WEEK END BEFORE REDU WEEK START = IF(DATEDIFF([RDU WEEK START], [RDU WEEK END], DAY) < 0, "YES", BLANK())

IS MIN DATA DATE = IF([DATA_DATE] = CALCULATE(MIN([DATA_DATE]), ALLEXCEPT('Weekly Trace Files', 'Weekly Trace Files'[SY])), "YES", BLANK())

EV per Shift = IF([DURATION] > 0, [Total EV] / [DURATION], BLANK())

Remaining EV = IF([Total EV] <> BLANK() && [Total EV] <> 0, (1 - ([% PROGRESS]/100)) * [Total EV], BLANK())

PREVIOUS WSRC = LOOKUPVALUE('Weekly Trace Files'[WORK STOPPAGE REASON CODE], [INDEX], [INDEX] - 1, [ICN/KO], [ICN/KO])

PREVIOUS ERD = LOOKUPVALUE('Weekly Trace Files'[ESTIMATED RESOLUTION DATE], 'Weekly Trace Files'[ICN/KO], [ICN/KO], 'Weekly Trace Files'[INDEX], [INDEX]-1)
